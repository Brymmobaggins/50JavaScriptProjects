"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const { filterExcludedPaths, getPathsOfIncludedFiles } = require('../../utils/included_files');
const { getPackageJson } = require('../../utils/package_json');
const { getNewCache } = require('../../utils/traversal_cache');
const { getDependencyPathsForDependency } = require('../zisi/traverse');
const getSrcFiles = ({ config, mainFile, pluginsModulesPath, srcDir }) => __awaiter(void 0, void 0, void 0, function* () {
    const { externalNodeModules = [], includedFiles = [], includedFilesBasePath } = config;
    const { exclude: excludedPaths, paths: includedFilePaths } = yield getPathsOfIncludedFiles(includedFiles, includedFilesBasePath);
    const dependencyPaths = yield getSrcFilesForDependencies({
        dependencies: externalNodeModules,
        basedir: srcDir,
        pluginsModulesPath,
    });
    const includedPaths = filterExcludedPaths([...dependencyPaths, ...includedFilePaths], excludedPaths);
    return [...includedPaths, mainFile];
});
const getSrcFilesForDependencies = function ({ dependencies: dependencyNames, basedir, state = getNewCache(), pluginsModulesPath, }) {
    return __awaiter(this, void 0, void 0, function* () {
        if (dependencyNames.length === 0) {
            return [];
        }
        const packageJson = yield getPackageJson(basedir);
        const dependencies = yield Promise.all(dependencyNames.map((dependencyName) => getSrcFilesForDependency({
            dependency: dependencyName,
            basedir,
            state,
            packageJson,
            pluginsModulesPath,
        })));
        const paths = new Set(dependencies.flat());
        return [...paths];
    });
};
const getSrcFilesForDependency = function ({ dependency, basedir, state = getNewCache(), packageJson, pluginsModulesPath, }) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const paths = yield getDependencyPathsForDependency({ dependency, basedir, state, packageJson, pluginsModulesPath });
            return paths;
        }
        catch (error) {
            if (error.code === 'MODULE_NOT_FOUND') {
                return [];
            }
            throw error;
        }
    });
};
module.exports = { getSrcFiles };
//# sourceMappingURL=src_files.js.map